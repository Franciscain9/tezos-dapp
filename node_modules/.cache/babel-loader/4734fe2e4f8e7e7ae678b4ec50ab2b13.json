{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\n  result[\"default\"] = mod;\n  return result;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst blakejs = __importStar(require(\"blakejs\"));\n\nconst TezosLanguageUtil_1 = require(\"../TezosLanguageUtil\");\n\nconst TezosNodeReader_1 = require(\"../TezosNodeReader\");\n\nvar TezosContractUtils;\n\n(function (TezosContractUtils) {\n  function verifyDestination(server, address, expected) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const contract = yield TezosNodeReader_1.TezosNodeReader.getAccountForBlock(server, 'head', address);\n\n      if (!!!contract.script) {\n        throw new Error(`No code found at ${address}`);\n      }\n\n      const k = Buffer.from(blakejs.blake2s(JSON.stringify(contract.script.code), null, 16)).toString('hex');\n\n      if (k !== expected) {\n        throw new Error(`Contract code hash \"${k}\" doesn't match expected ${expected}`);\n      }\n\n      return true;\n    });\n  }\n\n  TezosContractUtils.verifyDestination = verifyDestination;\n\n  function verifyScript(script, expected) {\n    const k = Buffer.from(blakejs.blake2s(TezosLanguageUtil_1.TezosLanguageUtil.preProcessMichelsonScript(script).join('\\n'), null, 16)).toString('hex');\n\n    if (k !== expected) {\n      throw new Error(`Contract code hash \"${k}\" doesn't match expected ${expected}`);\n    }\n\n    return true;\n  }\n\n  TezosContractUtils.verifyScript = verifyScript;\n\n  function clearRPCOperationGroupHash(hash) {\n    return hash.replace(/\\\"/g, '').replace(/\\n/, '');\n  }\n\n  TezosContractUtils.clearRPCOperationGroupHash = clearRPCOperationGroupHash;\n})(TezosContractUtils = exports.TezosContractUtils || (exports.TezosContractUtils = {}));","map":{"version":3,"sources":["../../../../src/chain/tezos/contracts/TezosContractUtils.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAA,OAAA,GAAA,YAAA,CAAA,OAAA,CAAA,SAAA,CAAA,CAAA;;AAEA,MAAA,mBAAA,GAAA,OAAA,CAAA,sBAAA,CAAA;;AACA,MAAA,iBAAA,GAAA,OAAA,CAAA,oBAAA,CAAA;;AAKA,IAAiB,kBAAjB;;AAAA,CAAA,UAAiB,kBAAjB,EAAmC;AAQ/B,WAAsB,iBAAtB,CAAwC,MAAxC,EAAwD,OAAxD,EAAyE,QAAzE,EAAyF;;AACrF,YAAM,QAAQ,GAAG,MAAM,iBAAA,CAAA,eAAA,CAAgB,kBAAhB,CAAmC,MAAnC,EAA2C,MAA3C,EAAmD,OAAnD,CAAvB;;AAEA,UAAI,CAAC,CAAC,CAAC,QAAQ,CAAC,MAAhB,EAAwB;AAAE,cAAM,IAAI,KAAJ,CAAU,oBAAoB,OAAO,EAArC,CAAN;AAAiD;;AAE3E,YAAM,CAAC,GAAG,MAAM,CAAC,IAAP,CAAY,OAAO,CAAC,OAAR,CAAgB,IAAI,CAAC,SAAL,CAAe,QAAQ,CAAC,MAAT,CAAgB,IAA/B,CAAhB,EAAsD,IAAtD,EAA4D,EAA5D,CAAZ,EAA6E,QAA7E,CAAsF,KAAtF,CAAV;;AAEA,UAAI,CAAC,KAAK,QAAV,EAAoB;AAAE,cAAM,IAAI,KAAJ,CAAU,uBAAuB,CAAC,4BAA4B,QAAQ,EAAtE,CAAN;AAAkF;;AAExG,aAAO,IAAP;AACH,K;AAAA;;AAVqB,EAAA,kBAAA,CAAA,iBAAA,GAAiB,iBAAjB;;AAiBtB,WAAgB,YAAhB,CAA6B,MAA7B,EAA6C,QAA7C,EAA6D;AACzD,UAAM,CAAC,GAAG,MAAM,CAAC,IAAP,CAAY,OAAO,CAAC,OAAR,CAAgB,mBAAA,CAAA,iBAAA,CAAkB,yBAAlB,CAA4C,MAA5C,EAAoD,IAApD,CAAyD,IAAzD,CAAhB,EAAgF,IAAhF,EAAsF,EAAtF,CAAZ,EAAuG,QAAvG,CAAgH,KAAhH,CAAV;;AAEA,QAAI,CAAC,KAAK,QAAV,EAAoB;AAAE,YAAM,IAAI,KAAJ,CAAU,uBAAuB,CAAC,4BAA4B,QAAQ,EAAtE,CAAN;AAAkF;;AAExG,WAAO,IAAP;AACH;;AANe,EAAA,kBAAA,CAAA,YAAA,GAAY,YAAZ;;AAQhB,WAAgB,0BAAhB,CAA2C,IAA3C,EAAuD;AACnD,WAAO,IAAI,CAAC,OAAL,CAAa,KAAb,EAAoB,EAApB,EAAwB,OAAxB,CAAgC,IAAhC,EAAsC,EAAtC,CAAP;AACH;;AAFe,EAAA,kBAAA,CAAA,0BAAA,GAA0B,0BAA1B;AAGnB,CApCD,EAAiB,kBAAkB,GAAlB,OAAA,CAAA,kBAAA,KAAA,OAAA,CAAA,kBAAA,GAAkB,EAAlB,CAAjB","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\n    result[\"default\"] = mod;\n    return result;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst blakejs = __importStar(require(\"blakejs\"));\nconst TezosLanguageUtil_1 = require(\"../TezosLanguageUtil\");\nconst TezosNodeReader_1 = require(\"../TezosNodeReader\");\nvar TezosContractUtils;\n(function (TezosContractUtils) {\n    function verifyDestination(server, address, expected) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const contract = yield TezosNodeReader_1.TezosNodeReader.getAccountForBlock(server, 'head', address);\n            if (!!!contract.script) {\n                throw new Error(`No code found at ${address}`);\n            }\n            const k = Buffer.from(blakejs.blake2s(JSON.stringify(contract.script.code), null, 16)).toString('hex');\n            if (k !== expected) {\n                throw new Error(`Contract code hash \"${k}\" doesn't match expected ${expected}`);\n            }\n            return true;\n        });\n    }\n    TezosContractUtils.verifyDestination = verifyDestination;\n    function verifyScript(script, expected) {\n        const k = Buffer.from(blakejs.blake2s(TezosLanguageUtil_1.TezosLanguageUtil.preProcessMichelsonScript(script).join('\\n'), null, 16)).toString('hex');\n        if (k !== expected) {\n            throw new Error(`Contract code hash \"${k}\" doesn't match expected ${expected}`);\n        }\n        return true;\n    }\n    TezosContractUtils.verifyScript = verifyScript;\n    function clearRPCOperationGroupHash(hash) {\n        return hash.replace(/\\\"/g, '').replace(/\\n/, '');\n    }\n    TezosContractUtils.clearRPCOperationGroupHash = clearRPCOperationGroupHash;\n})(TezosContractUtils = exports.TezosContractUtils || (exports.TezosContractUtils = {}));\n//# sourceMappingURL=TezosContractUtils.js.map"]},"metadata":{},"sourceType":"script"}